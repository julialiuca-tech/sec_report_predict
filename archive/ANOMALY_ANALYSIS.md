# Ratio Feature Anomaly Analysis

This document analyzes the ratio features generated by `feature_augment.py` and identifies anomalies compared to expected normal ranges.

## Summary of Anomalies

Based on the sample output, there are **severe anomalies** in most ratios. The pattern is consistent:
- **Medians and sample values are mostly reasonable** (within expected ranges)
- **Means are extremely skewed** by outliers (huge differences from medians)
- **Extremely large standard deviations** confirm the presence of extreme outliers

This suggests the data contains extreme outlier values that are skewing the means, while the majority of data (represented by medians and samples) is reasonable.

## Detailed Anomaly Report by Ratio

### ðŸ”´ CRITICAL ANOMALIES

#### 1. **GrossMargin_1qtrs_augment**
- **Expected Range:** 0.20-0.70 (20-70%), must be â‰¤ 1.0
- **Mean:** 1.4994 âš ï¸ **EXCEEDS 1.0 - LOGICAL VIOLATION**
- **Median:** 0.3575 âœ… (reasonable)
- **Sample:** [0.3824, 0.3701, 0.3585] âœ… (all reasonable)
- **Issue:** Mean exceeds 1.0, indicating some values violate the logical bound (gross profit > revenue)

#### 2. **CurrentRatio_0qtrs_augment**
- **Expected Range:** 1.5-3.0
- **Mean:** 1153.69 âš ï¸ **EXTREME OUTLIER**
- **Median:** 1.8292 âœ… (within range)
- **Sample:** [3.8252, 2.3158, 2.6377] âœ… (reasonable, first slightly high)
- **Issue:** Mean is 630x larger than median - severe outliers present

#### 3. **CashRatio_0qtrs_augment**
- **Expected Range:** 0.2-0.5
- **Mean:** 236.72 âš ï¸ **EXTREME OUTLIER**
- **Median:** 0.4903 âœ… (within range)
- **Sample:** [0.1714, 0.1328, 0.0759] âš ï¸ (slightly below range)
- **Issue:** Mean is 483x larger than median - extreme outliers

#### 4. **DebtToAssets_0qtrs_augment**
- **Expected Range:** 0.3-0.6, must be â‰¤ 1.0
- **Mean:** 11042.15 âš ï¸ **EXTREME OUTLIER + EXCEEDS 1.0**
- **Median:** 0.4668 âœ… (within range)
- **Sample:** [0.4641, 0.3281, 0.3316] âœ… (all reasonable)
- **Issue:** Mean exceeds logical bound of 1.0 by 11,000x - severe data issues

#### 5. **DebtToEquity_0qtrs_augment**
- **Expected Range:** Below 2.0 preferred
- **Mean:** 23855.14 âš ï¸ **EXTREME OUTLIER**
- **Median:** 1.0018 âœ… (within range)
- **Sample:** [1.0524, 0.5881, 1.2568] âœ… (all reasonable)
- **Issue:** Mean is 23,800x larger than median

#### 6. **ROE_1qtrs_augment**
- **Expected Range:** 0.10-0.20 (10-20%) is good
- **Mean:** 312.14 âš ï¸ **EXTREME OUTLIER**
- **Median:** 0.0174 âš ï¸ (1.74% - below expected range)
- **Sample:** [-0.0367, 0.0179, 0.0275] âœ… (reasonable)
- **Issue:** Mean is 17,900x larger than median

#### 7. **AssetTurnover_1qtrs_augment**
- **Expected Range:** >0.45 (45%) is strong, 0.30-0.45 is caution
- **Mean:** 54.69 âš ï¸ **EXTREME OUTLIER**
- **Median:** 0.1064 âš ï¸ (10.64% - below expected range)
- **Sample:** [0.2957, 0.3352, 0.3015] âœ… (reasonable)
- **Issue:** Mean is 514x larger than median

### ðŸŸ¡ MODERATE ANOMALIES

#### 8. **OperatingMargin_1qtrs_augment**
- **Expected Range:** 0.05-0.15 (5-15%)
- **Mean:** -81.98 âš ï¸ (very negative)
- **Median:** 0.0413 âš ï¸ (4.13% - slightly below range)
- **Sample:** [0.0430, 0.0912, 0.0395] âœ… (reasonable)
- **Issue:** Mean is extremely negative while median is positive - many companies with losses

#### 9. **NetMargin_1qtrs_augment**
- **Expected Range:** 0.05-0.15 (5-15%)
- **Mean:** -68.85 âš ï¸ (very negative)
- **Median:** 0.0332 âš ï¸ (3.32% - below range)
- **Sample:** [0.0241, 0.0613, 0.0232] âœ… (reasonable)
- **Issue:** Mean extremely negative, median below expected range

#### 10. **ROA_1qtrs_augment**
- **Expected Range:** >0.05 (5%) is good
- **Mean:** -39.78 âš ï¸ (very negative)
- **Median:** 0.0023 âš ï¸ (0.23% - well below expected range)
- **Sample:** [-0.0162, 0.0100, 0.0148] âœ… (reasonable)
- **Issue:** Mean very negative, median extremely low

#### 11. **InterestCoverage_1qtrs_augment**
- **Expected Range:** 2.0+ is good
- **Mean:** -448.55 âš ï¸ (extremely negative)
- **Median:** 1.6528 âš ï¸ (slightly below 2.0)
- **Sample:** [16.4865, 16.5682, 17.3902] âœ… (excellent - way above 2.0)
- **Issue:** Mean extremely negative while samples are excellent - many companies with losses

### ðŸŸ¢ MINOR ISSUES / ACCEPTABLE

#### 12. **QuickRatio_0qtrs_augment**
- **Expected Range:** 1.0-2.0
- **Mean:** 2.2779 âš ï¸ (slightly above range)
- **Median:** 1.3171 âœ… (within range)
- **Sample:** [2.6712, 1.2090, 1.3719] âœ… (reasonable, first slightly high)
- **Status:** Acceptable - slightly high mean but within reasonable bounds

#### 13. **InventoryTurnover_1qtrs_augment**
- **Expected Range:** 4-12 times per year (varies by industry)
- **Mean:** 3.18 âš ï¸ (slightly below range)
- **Median:** 1.0305 âš ï¸ (below range - may be quarterly, not annualized)
- **Sample:** [0.8448, 0.8384, 0.8630] âš ï¸ (all below range)
- **Status:** Needs investigation - values seem too low, may need annualization

#### 14. **ReceivablesTurnover_1qtrs_augment**
- **Expected Range:** 10-12 times per year
- **Mean:** 23.80 âš ï¸ (above range)
- **Median:** 2.0247 âš ï¸ (below range - may be quarterly, not annualized)
- **Sample:** [1.2950, 1.1518, 1.1251] âš ï¸ (all below range)
- **Status:** Needs investigation - inconsistency between mean and median suggests outliers

## Root Causes of Anomalies

### 1. **Extreme Outliers**
Most ratios show means that are orders of magnitude larger than medians, indicating:
- **Data quality issues**: Incorrect values in source data
- **Division by very small numbers**: When denominators are near zero, ratios explode
- **Special cases**: Companies with unusual structures (negative equity, near-zero assets, etc.)

### 2. **Logical Bound Violations**
Some ratios exceed logical bounds:
- **GrossMargin > 1.0**: Gross profit cannot exceed revenue (data error)
- **DebtToAssets > 1.0**: Debt cannot exceed assets (data error or calculation issue)

### 3. **Negative Values**
Many profitability ratios have very negative means:
- Legitimate: Companies can have losses
- Problem: Extreme negative values may indicate data quality issues or calculation errors

### 4. **Quarterly vs Annual**
Efficiency ratios (Inventory Turnover, Receivables Turnover) may need annualization:
- Current values appear to be quarterly
- Expected ranges are typically annualized

## Recommendations

### Immediate Actions

1. **Investigate Extreme Outliers**
   - Identify rows with extreme values (e.g., CurrentRatio > 100, DebtToAssets > 1.0)
   - Check if these are data errors or legitimate special cases
   - Consider capping or flagging extreme values

2. **Fix Logical Bound Violations**
   - GrossMargin > 1.0 should never occur - investigate and fix
   - DebtToAssets > 1.0 should never occur - investigate and fix

3. **Handle Near-Zero Denominators**
   - Add checks for very small denominators before division
   - Cap ratios at reasonable maximums or mark as invalid

4. **Consider Using Medians**
   - For modeling, consider using median-based aggregations instead of means
   - Or apply robust scaling that's less sensitive to outliers

### Data Quality Improvements

1. **Add Denominator Checks**
   ```python
   # Example: Check if denominator is too small
   if abs(denominator) < threshold:
       return np.nan  # or cap at reasonable value
   ```

2. **Cap Extreme Values**
   - Set reasonable maximums for each ratio type
   - Flag values exceeding these caps for investigation

3. **Handle Negative Equity Cases**
   - When equity is negative, ROE becomes misleading
   - Consider flagging or handling these cases specially

4. **Annualize Quarterly Turnover Ratios**
   - Multiply quarterly turnover by 4 to get annual rates
   - Or document that values are quarterly

### Model Impact

1. **Use Robust Statistics**
   - Consider using median instead of mean for aggregations
   - Use robust scaling (e.g., RobustScaler in sklearn)

2. **Outlier Treatment**
   - Cap extreme values before modeling
   - Use log transformations for heavily skewed ratios
   - Consider winsorization (capping at 1st and 99th percentiles)

3. **Feature Engineering**
   - Create flags for extreme values
   - Use percentile-based features instead of raw ratios

## Next Steps

1. Run the new `flag_outlier_by_expected_range()` function to get detailed statistics
2. Identify specific rows with extreme values for investigation
3. Implement denominator checks and value capping
4. Document handling of special cases (negative equity, near-zero denominators)
5. Consider annualizing quarterly turnover ratios if needed

